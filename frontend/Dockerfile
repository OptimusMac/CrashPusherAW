# -----------------------------
# Stage 1: Build
# -----------------------------
FROM node:20-alpine AS build
WORKDIR /app

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Å–±–æ—Ä–∫–∏
COPY package*.json ./

# –õ—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å npm ci –¥–ª—è —á–∏—Å—Ç–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ devDependencies
RUN echo "Installing dependencies at $(date)" && npm ci

# –ö–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
COPY . .

# –ü–µ—Ä–µ–¥–∞—ë–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Vite
ARG VITE_API_BASE=http://localhost:8081/api
ENV VITE_API_BASE=$VITE_API_BASE

RUN echo "üîÑ Building with VITE_API_BASE: $VITE_API_BASE"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ vite
RUN ls -la node_modules/.bin/vite || echo "Vite not found in node_modules"

# –°–æ–±–∏—Ä–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ node
RUN node ./node_modules/vite/bin/vite.js build

# -----------------------------
# Stage 2: Production
# -----------------------------
FROM nginx:alpine
RUN apk add --no-cache gettext

# –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–±—Ä–∞–Ω–Ω—ã–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥, node_modules –Ω–µ –Ω—É–∂–Ω—ã
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf.template /etc/nginx/nginx.conf.template
COPY docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

EXPOSE ${FRONTEND_PORT}
CMD ["/docker-entrypoint.sh"]
